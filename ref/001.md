[blog:g:12921228815727798627:banner]

[:contents]

ことの発端は
S.Aokiさんのツイート…（ありがとうございます！）

[https://twitter.com/shumaaoki/status/1817936515642859793?s=61&t=d-b-2JwHYKw2bIxbpxwfhQ:embed]


# CTからSTL…どういうこと？

CTはDICOMというデータ形式で、ボクセルという単位でCT値が記録されています。
それを３方向から断面図で診る…というのが一般的な使い方ではないでしょうか。
<figure class="figure-image figure-image-fotolife" title="３方向から見た私の何故か４根ある上顎６番">[f:id:ainem:20240731124902p:plain]<figcaption>３方向から見た私の何故か４根ある上顎６番</figcaption></figure>

### セグメンテーション
CTのセグメンテーション（Computed Tomography Segmentation）は、CTスキャン画像から特定の構造や領域を見つけて分ける作業です。
つまり、先程の３面図の集合であるCTデータから、こんな↓感じの３Dデータを切り出す作業のことです。
[https://twitter.com/lacramydent/status/1818227953962308020?s=61&t=CVrfvofTgJkpgl_ofWwFfQ:embed]
従来のセグメンテーションは、手動で行う((スライスごとに色を塗っていく、地道で地道で地道な作業！！！))と時間がかかりますが、最近では深層学習や機械学習…いわゆるAIを使った自動化が進んでいます。

### ノートパソコンでも動かせるAIセグメンテーション！
AIを使った計算は通常ハイスペックなパソコンが必要になることが多いのですが、今回m1 macbook air（４年もののノートパソコン）でもこのAIによるセグメンテーションを行えるソフトウェアが発表されたので、使い方を紹介させていただきます。

# 3D Slicer
[https://www.slicer.org:embed:cite]

[3D Slicer](https://www.slicer.org)は、無料でオープンソースのソフトウェアプラットフォームで、医療や生物医学の画像の可視化、処理、セグメンテーション、登録、および解析を行うことができます。
外科手術の計画やナビゲーション、AIによるセグメンテーションなど、多様な拡張機能があるのが特徴で、BSDライセンスの下で商用利用も可能です。
今回この3D Slicerに[DentalSegmentator](https://github.com/gaudot/SlicerDentalSegmentator)という拡張機能が出たので、紹介していきます。





## 3D Slicerのインストール

### 1. ソフトウェアのダウンロード

まず、公式ウェブサイトから3D Slicerのインストーラをダウンロードします。`Download*ページにアクセスし、**previewバージョン**のインストーラを選択してダウンロードボタンをクリックします。
<figure class="figure-image figure-image-fotolife" title="ダウンロードページ：今回の機能を使うためには下段をダウンロードしてください">[f:id:ainem:20240731141601p:plain]<figcaption>ダウンロードページ：今回の機能を使うためには下段をダウンロードしてください</figcaption></figure>



### 2. インストーラの実行

#### Macの場合
<figure class="figure-image figure-image-fotolife" title="macのインストーラ">[f:id:ainem:20240731142248p:plain]<figcaption>macのインストーラ</figcaption></figure>
`ダウンロード`フォルダにあるインストーラをダブルクリックします
<figure class="figure-image figure-image-fotolife" title="ライセンス契約が表示されます">[f:id:ainem:20240731142543p:plain]<figcaption>ライセンス契約が表示されます</figcaption></figure>
`Agree`をクリックすると、アプリケーションフォルダとSlicerアイコンが表示されるので、Slicerのアイコンをアプリケーションフォルダにドラッグアンドドロップします。
[f:id:ainem:20240731143011p:plain]


#### Windowsの場合
`ダウンロード`フォルダにあるインストーラをダブルクリックします
<figure class="figure-image figure-image-fotolife" title="Winのインストーラ">[f:id:ainem:20240731151433p:plain]<figcaption>Winのインストーラ</figcaption></figure>
<figure class="figure-image figure-image-fotolife" title="インストーラの起動">[f:id:ainem:20240731151507p:plain]<figcaption>インストーラの起動</figcaption></figure>
<figure class="figure-image figure-image-fotolife" title="同意するをクリック">[f:id:ainem:20240731151544p:plain]<figcaption>同意するをクリック</figcaption></figure>
`同意する`をクリックすると、インストール先を選択する画面になります、通常そのまま次へを押して進んでOKです。
<figure class="figure-image figure-image-fotolife" title="インストール先">[f:id:ainem:20240731151746p:plain]<figcaption>インストール先</figcaption></figure>
インストール先を変更する必要のある場合は、例えばCドライブの容量が足りずDドライブにインストールしたいとき、などです（Pytorchやcudaや学習モデルのインストールでざっくり５GBぐらい必要になります）
<figure class="figure-image figure-image-fotolife" title="スタートメニューへの登録">[f:id:ainem:20240731151808p:plain]<figcaption>スタートメニューへの登録</figcaption></figure>
こちらも通常はそのまま`インストール`をクリック
<figure class="figure-image figure-image-fotolife" title="２つチェックボックスがあります">[f:id:ainem:20240731152610p:plain]<figcaption>２つチェックボックスがあります</figcaption></figure>
上のチェックをすると、すぐに3D Slicerが起動されます。
[f:id:ainem:20240731152732p:plain]
下のチェックをすると、デスクトップにSlicerのショートカットが作成されます。


<span style="font-size: 150%"><span style="color: #ff5252">**これでインストール完了です！！**</span></span>

> #### ！！上級者向け：homebrew((homebrew, scoop, aptなどパッケージマネージャと呼ばれるソフトは、入れておくとソフトのインストールやバージョン管理が楽になります。わざわざwebサイトまでダウンロードしにいかなくても、コマンド一行でインストール完了！アンインストールもコマンド一行！))を使ったインストール
> 
> `brew install slicer@preview`で2. インストールの手順を飛ばすことができます。というかこれ分かる人はこの記事読む必要がないと思いますが…  
> 一応、homebrewでインストールした後は、アプリケーションフォルダから右クリック→開くで起動しましょう（釈迦に説法）
> <figure class="figure-image figure-image-fotolife" title="terminalが開ける人向けの説明です">[f:id:ainem:20240731142003p:plain]<figcaption>terminalが開ける人向けの説明です</figcaption></figure>

## 3D Slicerの実行
### 起動

#### Macの場合
Launchpadから起動しましょう[f:id:ainem:20240731152414p:plain]

<figure class="figure-image figure-image-fotolife" title="インターネットからインストールするとこのエラーが出ることがある">[f:id:ainem:20240731153420p:plain]<figcaption>インターネットからインストールするとこのエラーが出ることがある</figcaption></figure>
このエラーが出た場合、`アプリケーション`フォルダを開き、Slicerを右クリックして開くを押して起動しましょう
<figure class="figure-image figure-image-fotolife" title="右クリック→開くから起動するとこの画面から開けるようになります">[f:id:ainem:20240731153534p:plain]<figcaption>右クリック→開くから起動するとこの画面から開けるようになります</figcaption></figure>

#### Windowsの場合
デスクトップにショートカットを作製した場合は、そこから  
[f:id:ainem:20240731152836p:plain]
作製しなかった場合は、スタートメニューから起動しましょう


### 操作方法
<figure class="figure-image figure-image-fotolife" title="初回起動時のメッセージ">[f:id:ainem:20240731152926p:plain]<figcaption>初回起動時のメッセージ</figcaption></figure>
初めて起動した際には、
> このソフトは医療用に開発されたわけじゃないよ

と表示されます。薬機登録されてないからですね((このソフトを使って治療を行う際は、保険診療ではなく自費診療で、患者さんに同意を得て使うようにしましょう。詳しくは語りません。))

ここからはWindows Mac共通の操作です。
#### DentalSegmentatorのインストール
3D Slicerというソフトの追加機能が今回使いたい機能ですので、これを追加していきましょう。

[f:id:ainem:20240731155327p:plain]
`Install Extensions`をクリックします  
<figure class="figure-image figure-image-fotolife" title="Extension Manager">[f:id:ainem:20240731155548p:plain]<figcaption>Extension Manager</figcaption></figure>
右上に`DentalSeg`と入力して**DentalSegmentator**を検索し、`Install`をクリックします
[f:id:ainem:20240731160826p:plain]

[f:id:ainem:20240731160855p:plain]
その後、右下の`restart`をクリックして、拡張機能の追加を反映させるためにSlicerを再起動します

#### サンプルデータのダウンロード
<figure class="figure-image figure-image-fotolife" title="サンプルデータのダウンロード">[f:id:ainem:20240731161133p:plain]<figcaption>サンプルデータのダウンロード</figcaption></figure>

`Download Sample Data`をクリックします
<figure class="figure-image figure-image-fotolife" title="サンプルデータ">[f:id:ainem:20240731161227p:plain]<figcaption>サンプルデータ</figcaption></figure>
`CBCTDentalSurgery`をクリックします
[f:id:ainem:20240731161357p:plain]
すると、右側にCTが表示されます。それぞれのスライスはスクロールできます。

#### セグメンテーション
メニューのModules:`Sample Data`と書いてあるところのドロップダウンメニューから、`Segmentation`→`DentalSegmentator`をクリック
> 注意：上の方にある`Segmentations`ではないことに注意！

<figure class="figure-image figure-image-fotolife" title="DentalSegmentator">[f:id:ainem:20240731161827p:plain]<figcaption>DentalSegmentator</figcaption></figure>
**DentalSegmentator**を起動できたら、Device:`cuda`となっているドロップダウンメニューをクリック
- cuda: geforce系のグラフィックボードが搭載されているPCの場合、こちらを選びます。高速です(数十秒で完了)
- cpu: それ以外の場合(macを含む)はこちらを選択します。低速です(十数分かかります)
> mpsは選択しないでください。まだ対応していません！

`Apply`をクリックするとセグメンテーションが始まります！！

[f:id:ainem:20240731162121p:plain]
初回は、機械学習のためのソフトをインストールします、という警告が表示されます。
`a few minutes`とか`several minutes`かかるとか書いてありますが、普通に十数分かかることもあります。待ちましょう。
<details>
<summary>待ち時間暇な方へ（インストールされる各モジュールの説明）</summary>
ここでインストールされるプログラムたちは機械学習のために使われます。
chatGPTにそれぞれがどんな役割を持つか聞いてみたので、暇つぶしに読んでみるのも一興だと思います。
<ol>
  <li><strong>pandas</strong>:
    <ul>
      <li>データ操作と分析のための高性能なデータ構造とデータ解析ツールを提供します。特に、データフレーム（2次元のラベル付きデータ構造）が有名です。</li>
    </ul>
  </li>
  <li><strong>pillow (PIL)</strong>:
    <ul>
      <li>画像処理ライブラリで、画像の開閉、変換、操作、保存などを簡単に行えます。画像ファイルを扱う際によく使われます。</li>
    </ul>
  </li>
  <li><strong>nnunetv2</strong>:
    <ul>
      <li>医療画像解析に特化したディープラーニングフレームワークで、特にセグメンテーションに使用されます。<code>--no-deps</code>は依存関係をインストールしないオプションです。</li>
    </ul>
  </li>
  <li><strong>acvl-utils</strong>:
    <ul>
      <li>機械学習およびコンピュータビジョン関連のユーティリティツールを提供します。主にデータ前処理や評価指標に関する機能があります。</li>
    </ul>
  </li>
  <li><strong>batchgenerators</strong>:
    <ul>
      <li>データ前処理やデータ拡張のためのジェネレータを提供するライブラリです。主にバッチ処理を効率的に行うために使います。</li>
    </ul>
  </li>
  <li><strong>scikit-image</strong>:
    <ul>
      <li>画像処理のためのライブラリで、様々な画像処理アルゴリズムを提供します。画像の変換、フィルタリング、セグメンテーションなどに利用されます。</li>
    </ul>
  </li>
  <li><strong>networkx</strong>:
    <ul>
      <li>グラフ（ネットワーク）理論に基づいたデータ構造とアルゴリズムを提供するライブラリです。グラフの操作、解析、視覚化が可能です。</li>
    </ul>
  </li>
  <li><strong>imageio</strong>:
    <ul>
      <li>画像とビデオの読み込みや書き込みを簡単に行うためのライブラリです。多くのファイル形式に対応しています。</li>
    </ul>
  </li>
  <li><strong>tifffile</strong>:
    <ul>
      <li>TIFF形式の画像ファイルを読み書きするためのライブラリです。特に科学的画像データの処理に使われます。</li>
    </ul>
  </li>
  <li><strong>lazy-loader</strong>:
    <ul>
      <li>必要になるまでモジュールやパッケージを遅延して読み込むためのツールです。リソースの効率的な管理に役立ちます。</li>
    </ul>
  </li>
  <li><strong>scikit-learn</strong>:
    <ul>
      <li>機械学習のためのライブラリで、回帰、分類、クラスタリング、次元削減などのアルゴリズムを提供します。</li>
    </ul>
  </li>
  <li><strong>joblib</strong>:
    <ul>
      <li>高速なピクル化（データの保存）と並列処理をサポートするライブラリです。大規模なデータセットや計算に便利です。</li>
    </ul>
  </li>
  <li><strong>threadpoolctl</strong>:
    <ul>
      <li>スレッドプールの制御を提供するライブラリで、並列処理のパフォーマンスを調整するために使用されます。</li>
    </ul>
  </li>
  <li><strong>future</strong>:
    <ul>
      <li>Python 2とPython 3の互換性を確保するためのツールです。特に、Python 3の機能をPython 2で使えるようにします。</li>
    </ul>
  </li>
  <li><strong>unittest2</strong>:
    <ul>
      <li>Pythonの標準ユニットテストライブラリの拡張版で、Python 2.7以前のバージョンでのテスト機能を提供します。</li>
    </ul>
  </li>
  <li><strong>argparse</strong>:
    <ul>
      <li>コマンドライン引数を解析するためのライブラリで、スクリプトの引数処理を簡単にします。</li>
    </ul>
  </li>
  <li><strong>traceback2</strong>:
    <ul>
      <li>エラーメッセージを追跡するためのライブラリで、Python 2.6および2.7の機能を提供します。</li>
    </ul>
  </li>
  <li><strong>linecache2</strong>:
    <ul>
      <li>ソースコードファイルの行をキャッシュするためのライブラリで、デバッグやエラーメッセージの生成に役立ちます。</li>
    </ul>
  </li>
  <li><strong>connected-components-3d</strong>:
    <ul>
      <li>3Dデータに対する連結成分分析を行うためのライブラリです。3Dのバイナリデータのラベリングに使用されます。</li>
    </ul>
  </li>
  <li><strong>dynamic-network-architectures</strong>:
    <ul>
      <li>動的に構築できるネットワークアーキテクチャのライブラリです。特に機械学習や深層学習において柔軟なネットワーク設計を支援します。</li>
    </ul>
  </li>
  <li><strong>tqdm</strong>:
    <ul>
      <li>進捗バーを表示するためのライブラリで、長時間かかる処理の進捗を可視化します。</li>
    </ul>
  </li>
  <li><strong>dicom2nifti</strong>:
    <ul>
      <li>DICOM形式の医療画像をNIfTI形式に変換するためのツールです。医療画像処理に利用されます。</li>
    </ul>
  </li>
  <li><strong>nibabel</strong>:
    <ul>
      <li>ニューロイメージングデータ（NIfTI、Analyze形式など）の読み書きをサポートするライブラリです。</li>
    </ul>
  </li>
  <li><strong>python-gdcm</strong>:
    <ul>
      <li>DICOM画像の読み書きを行うためのライブラリで、GDcm（Grassroots DICOM）ライブラリに基づいています。</li>
    </ul>
  </li>
  <li><strong>graphviz</strong>:
    <ul>
      <li>グラフやネットワークの視覚化を行うためのツールです。グラフ構造を描画する際に使用されます。</li>
    </ul>
  </li>
  <li><strong>matplotlib</strong>:
    <ul>
      <li>データ可視化のためのライブラリで、グラフや図を描画するための豊富な機能を提供します。</li>
    </ul>
  </li>
  <li><strong>contourpy</strong>:
    <ul>
      <li>等高線の描画や計算を行うためのライブラリです。主にデータの可視化に使用されます。</li>
    </ul>
  </li>
  <li><strong>cycler</strong>:
    <ul>
      <li>プロットのスタイルや色をサイクルするためのツールです。<code>matplotlib</code>などの可視化ライブラリで使われます。</li>
    </ul>
  </li>
  <li><strong>fonttools</strong>:
    <ul>
      <li>フォントの処理や変換を行うためのライブラリです。フォントのメタデータやフォーマット変換をサポートします。</li>
すべてpythonのライブラリです。興味ある方は私と一緒に勉強してkaggle((kaggle: 機械学習のコンテスト　モデルを最適化し、最良のものを競い合う、優勝賞金もあります！))とかやってみませんか！？
</details>


<figure class="figure-image figure-image-fotolife" title="4分41秒経過・残り45分26秒　210回（イテレーション）の学習を行う予定で、1回の学習に19秒かかると書いてあります">[f:id:ainem:20240731163120p:plain]<figcaption>4分41秒経過・残り45分26秒　210回（イテレーション）の学習を行う予定で、1回の学習に19秒かかると書いてあります</figcaption></figure>


[f:id:ainem:20240731173440p:plain]
<span style="font-size: 150%"><span style="color: #ff5252">**セグメンテーション完了です！！**</span></span>

#### 8/1追記☆セグメンテーションの修正
akinaせんせい（@nakixa）が、セグメンテーションを手動で修正する方法を動画にしてくださいました！！！
ありがとうございます！
以下内容説明↓

0:08 セグメンテーションモデルの表示／非表示  
0:16 3Dモデルの動かし方  
0:24 画面のレイアウトの変更について  
0:33 セグメンテーションの修正の仕方  

[https://twitter.com/nakixa/status/1818887661022806490?s=61&t=ahuzXsYBYrp6Y83W0FPXtQ:embed]



#### STLデータのエクスポート（書き出し）
[f:id:ainem:20240731173726p:plain]
画面左側、下の方にある`Export`をクリックするだけです！  
指定したフォルダに保存されます。

## STLデータの活用

コンサルにつかうもよし、移植につかうもよし、埋伏歯の骨削のシミュレーションや口腔内スキャンとのマッチングなど…
後日追記予定です。

<figure class="figure-image figure-image-fotolife" title="3Dプリンタで印刷した、私の上顎骨">[f:id:ainem:20240731174202j:plain]<figcaption>3Dプリンタで印刷した、私の上顎骨</figcaption></figure>


[https://twitter.com/lacramydent/status/1768493300972163117?s=61&t=CVrfvofTgJkpgl_ofWwFfQ:embed]



さて、これが初めての記事でしたが１万字超えの大作になってしまいました…
これからもデジタルデンタルタメになるような情報を発信していけたらと考えています！
なにとぞよろしくお願いします。
